<!doctype html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="leap.min.js"></script>
<script type="text/javascript" src="jquery/jquery.js"></script>
<script type="text/javascript" src="js/dat.Gui.min.js"></script>

<script type="text/javascript" src="MIDIBridge/lib/Midibridge.js"></script>
<script type="text/javascript" src="MIDIBridge/lib/Midiselector.js"></script>
<script type="text/javascript" src="js/setup-connections-direct.js"></script>

	
		
<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
		
	
	<style>

	#rules
	{
		border: 5px solid #615521;
		border-radius: 15px;
		background: #E6E8CC;
		position:absolute;
		z-index: -1;
		margin-right:20px;
		margin-top:20px;
		padding:10px;
		
	}

	#cont
	{
		width:100%;

	}
	#mycanvas
	{
	    margin-top: 10px;
	    margin-left: auto;
    	margin-right: auto;
    	display: block;
    	height:400px;
    	width:600px;
    	border:3px grey solid
	}

	#clarific
	{
		border: 3px solid #5195F5;
		border-radius: 25px;
		background: #DAE5F5;
		position:absolute;
		margin-right:20px;
		margin-top:300px;
		padding:10px;
		

	}



	#signature
	{
		float:right;
	}

	#signature p
	{
		color:#A6A6A6;
		font-size: small;
	}

	</style>


<script type="text/javascript">

	
	var maxX = 127;
	var minX = 0;
	var maxY = 127;
	var minY = 0;
	var maxZ = 127;
	var minZ = 0;

	var MIDIchan = 1;
	var Xcont = 0;
	var Ycont = 1;
	var Zcont = 2;

	var leapvars =
	 {
	 	leapX: 50,
	 	leapY: 50,
	 	leapZ:100,
	 	salv: false
	 };


	//  window.onload = function() {
	// 	var gui = new dat.GUI();

	// 	gui.add(settings, 'Xcont', 0, 180); 

	// };







	var controller = new Leap.Controller({enableGestures: true});
    var region = new Leap.UI.Region(
    	[-100, 200, -100], 
    	[200, 300, 100]
    );

    controller.addStep(new Leap.UI.Cursor())
    controller.addStep(region.listener({nearThreshold:50}))



    controller.loop(function(frame, done) { 
      if (frame.cursorPosition) {
      	leap_enabled = true;

        var leapPosition = region.mapToXY(
        	frame.cursorPosition, 300, 150);

        leapvars.leapX = leapPosition[0];
        leapvars.leapY = leapPosition[1];
        leapvars.leapZ = leapPosition[2];
      	 
      }

      if(frame.gestures && frame.gestures.length !== 0) {
      	var gesture = frame.gestures[0];

      	if(gesture.type === 'circle') {
      		leapvars.salv = true;

      		setTimeout(function() {
        		leapvars.salv = false;
    		}, 2000);

      	};

	}
      done();
    });

    controller.connection.on('disconnect', function() {
    	leap_enabled = false;
    });










//----------------------------MIDI stuff -----------


window.addEventListener('load', function() {
    
    var midiAccess,
    outputs,
    output,
    midispeed = 100;
    delay = 300,
    currentNote = 0,
    sequenceLength = 100,
    sequencePosition = 0,
    selectOutput = document.getElementById("outputs"),
    messages = document.getElementById("messages"),
    btnStart = document.getElementById("start"),
    btnStop = document.getElementById("stop");

    var screenfps = 60;

    drawInterval = setInterval(drawScreen, Math.round(1000/screenfps));
    
    btnStart.addEventListener("click",function(){   
        if(!output){
            messages.innerHTML = "Please select a MIDI output first!";
            return;
        }
        messages.innerHTML = "";
        
        sequencePosition = 0;
        
        runningInterval = setInterval(MIDILoop, Math.round(midispeed));
		


    },false);

    




    btnStop.addEventListener("click",function(){    
        currentNote = sequenceLength;
    },false);
    

	function MIDILoop()
	{
		
		//send for X

		//noteNumber = Math.floor((Math.random() * 87) + 21);//noteNumber random between 21 (A0) an 108 (C8)
        //velocity = Math.floor((Math.random() * 127) + 10);//velocity random betweeen 10 and 127
		
        noteNumber = Xcont;
        velocity = (leapvars.leapX/300*(maxX-minX)) + minX;   //0-300   to 0-127


		midiMessage = midiAccess.createMIDIMessage(midiBridge.CONTROL_CHANGE, 0, noteNumber, velocity, sequencePosition);
        
        output.sendMIDIMessage(midiMessage);
        
        console.log("X sending " + velocity + " to port " + Xcont );
		//send for Y

		noteNumber = Ycont;
        velocity = (leapvars.leapY/150*(maxY-minY)) + minY;   //0-150   to 0-127


		midiMessage = midiAccess.createMIDIMessage(midiBridge.CONTROL_CHANGE, 0, noteNumber, velocity, sequencePosition);
        
        output.sendMIDIMessage(midiMessage);
        
        console.log("Y sending " + velocity + " to port " + Ycont );



		//send for Z


		noteNumber = Zcont;
        velocity = (leapvars.leapZ/2*(maxZ-minZ)) + minZ;   //0-2   to 0-127


		midiMessage = midiAccess.createMIDIMessage(midiBridge.CONTROL_CHANGE, 0, noteNumber, velocity, sequencePosition);
        
        output.sendMIDIMessage(midiMessage);
        
        console.log("Z sending " + velocity + " to port " + Zcont );



	}  








    
    
    
    midiBridge.init(function(_midiAccess){
        
        midiAccess = _midiAccess;
        outputs = midiAccess.enumerateOutputs();
        
        //create dropdown menu for MIDI outputs and add an event listener to the change event
        midiBridge.createMIDIDeviceSelector(selectOutput,outputs,"ouput",function(deviceId){
            if(output){
                output.close();
            }
            output = midiAccess.getOutput(outputs[deviceId]);
            messages.innerHTML = "connected to " + output.deviceName + "<br/>";
        });
    });
});



//---------------------DRAW------------------------------

	function drawScreen()
	{
		
		leap_drawScreen();
		

		var imgX = leapvars.leapX;
		var imgY = leapvars.leapY;
		var imgZ = leapvars.leapZ + 1;


		var c=document.getElementById("mycanvas");
		var ctx=c.getContext("2d");
		ctx.strokeStyle = "#000";
        ctx.fillStyle='red';
		ctx.beginPath();
        ctx.arc(imgX,imgY,12*imgZ,0,2*Math.PI);
        ctx.closePath();
        ctx.fill();
        //console.log("X:" + leapvars.leapX + "Y: " + leapvars.leapY);
        console.log("Z: " + imgZ + " X:" + imgX + " Y: " + imgY);
	}



	function leap_drawScreen()
	{
	  var c=document.getElementById("mycanvas");
	  var ctx=c.getContext("2d");
	  ctx.clearRect(0,0,c.width,c.height);
	  ctx.fillStyle="#FF3399";
	  ctx.beginPath();
	  ctx.arc(400,200,5,0,2*Math.PI);
	  ctx.moveTo(0,200);
	  ctx.lineTo(800,200);
	  ctx.moveTo(400,0);
	  ctx.lineTo(400,400);
	  ctx.stroke();
	  ctx.closePath();
	}




</script>


	</head>
		
	<body>

		
		<div id="rules" class="span3">	
	
		</div>
		<div id="clarific" class="span3">
		
			<div id="signature">
				<p>App by: <a href="http://nearnshaw.github.com" target="blank">Nicolas Earnshaw</a></p>
			</div>

		</div>
		<div id="cont" class="span6">
			<canvas id="mycanvas" ></canvas>
		</div>
	

		<div id="content" class="span3">
            <!-- dropdown menu for selecting a MIDI output -->
            <select id="outputs"></select>

            <!-- button that starts the sequence -->
            <input type="button" id="start" value="start" />

            <!-- button that stops the sequence -->
            <input type="button" id="stop" value="stop" />

            <!-- MIDI messages get displayed here -->
            <div id="messages">Please select a MIDI output<br/></div>
        </div>








	
		</body>

</html>